version: '3.1'
services:
    db:
        image: mysql
        command: --default-authentication-plugin=mysql_native_password
        restart: always
        environment:
            MYSQL_ROOT_PASSWORD: start123
            MYSQL_ROOT_HOST: '%'
        volumes:
            - pht_ui_db:/var/lib/mysql
    rabbitmq:
        image: 'docker.io/bitnami/rabbitmq:3.8-debian-10'
        environment:
            - RABBITMQ_USERNAME=admin
            - RABBITMQ_PASSWORD=start123
        ports:
            - '4369:4369'
            - '5672:5672'
            - '25672:25672'
            - '15672:15672'
        networks:
            - pht-backend
        volumes:
            - pht_ui_rabbitmq:/bitnami
    server:
        image: pht-server
        build: .
        depends_on:
            -  db
            -  rabbitmq
        ports:
            - '3002:3000'
        restart: always
        volumes:
            - pht_ui_server:/usr/src/app/writable
        environment:
            NODE_ENV: production
            PORT: 3000

            API_URL: http://localhost:3002/
            WEB_APP_URL: http://localhost:3000/

            VAULT_CONNECTION_STRING: s.jmMOV4W43R2zQ2WOuSQMwsV9@https://vault.pht.medic.uni-tuebingen.de/v1/
            RABBITMQ_CONNECTION_STRING: amqp://admin:start123@rabbitmq
            HARBOR_CONNECTION_STRING: pht:PangerLenis32@https://harbor.personalhealthtrain.de/api/v2.0/

            JWT_PROCEDURE: 'RSA'
            JWT_PRIVATE_KEY: writable/rsa.private
            JWT_PUBLIC_KEY: writable/rsa.public

            TYPEORM_CONNECTION: mysql
            #TYPEORM_CONNECTION: sqlite
            TYPEORM_HOST: db
            TYPEORM_USERNAME: root
            TYPEORM_PASSWORD: start123
            TYPEORM_DATABASE: app
            #TYPEORM_DATABASE: writable/db.sqlite
            TYPEORM_PORT: 3306
            TYPEORM_SYNCHRONIZE: 'false'
            TYPEORM_LOGGING: 'false'
            TYPEORM_ENTITIES: src/db/entities.ts
            TYPEORM_SUBSCRIBERS: src/db/subscribers.ts
            TYPEORM_SEEDING_SEEDS: src/db/seeds/**/*{.ts,.js}
volumes:
    pht_ui_db:
        external: true
    pht_ui_rabbitmq:
        external: true
    pht_ui_server:
        external: true
